# =============================================================================
# ZFS Scrub + ARC Tuning Tasks
# =============================================================================
# Imported by playbooks/zfs.yml
# Expects variables: zfs_pools, zfs_scrub_schedule, zfs_arc_max_bytes

- name: Skip ZFS scrub if not configured
  ansible.builtin.meta: end_host
  when: zfs_pools is not defined
  tags: [zfs-scrub]

# --- ZFS Scrub Schedule ---

- name: Deploy ZFS scrub script
  ansible.builtin.template:
    src: ../templates/zfs-scrub.sh.j2
    dest: /usr/local/sbin/zfs-scrub
    owner: root
    group: root
    mode: "0755"
  tags: [zfs-scrub]

- name: Deploy ZFS scrub systemd timer
  ansible.builtin.copy:
    dest: /etc/systemd/system/zfs-scrub.timer
    owner: root
    group: root
    mode: "0644"
    content: |
      # Managed by Ansible - playbooks/zfs.yml
      [Unit]
      Description=Weekly ZFS scrub

      [Timer]
      OnCalendar={{ zfs_scrub_schedule | default('Sun *-*-* 02:00:00') }}
      Persistent=true
      RandomizedDelaySec=300

      [Install]
      WantedBy=timers.target
  notify: Reload systemd for scrub
  tags: [zfs-scrub]

- name: Deploy ZFS scrub systemd service
  ansible.builtin.copy:
    dest: /etc/systemd/system/zfs-scrub.service
    owner: root
    group: root
    mode: "0644"
    content: |
      # Managed by Ansible - playbooks/zfs.yml
      [Unit]
      Description=ZFS pool scrub

      [Service]
      Type=oneshot
      ExecStart=/usr/local/sbin/zfs-scrub
  notify: Reload systemd for scrub
  tags: [zfs-scrub]

- name: Enable ZFS scrub timer
  ansible.builtin.systemd:
    name: zfs-scrub.timer
    enabled: true
    state: started
    daemon_reload: true
  tags: [zfs-scrub]

# --- ZFS ARC Tuning ---

- name: Configure ZFS ARC max
  ansible.builtin.copy:
    dest: /etc/modprobe.d/zfs.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      # Managed by Ansible - playbooks/zfs.yml
      # ZFS ARC max size (takes effect on reboot)
      options zfs zfs_arc_max={{ zfs_arc_max_bytes }}
  when: zfs_arc_max_bytes is defined
  tags: [zfs-scrub, zfs-tuning]

# --- ZFS Dataset Property Enforcement ---

- name: Enforce ZFS dataset properties
  ansible.builtin.shell: |
    changed=0
    {% for prop, val in item.value.items() %}
    current=$(zfs get -H -o value {{ prop }} {{ item.key }} 2>/dev/null)
    if [ "$current" != "{{ val }}" ]; then
      zfs set {{ prop }}={{ val }} {{ item.key }}
      changed=1
    fi
    {% endfor %}
    [ "$changed" = "1" ] && echo "CHANGED" || true
  register: zfs_enforce_result
  changed_when: "'CHANGED' in zfs_enforce_result.stdout"
  failed_when: zfs_enforce_result.rc != 0
  loop: "{{ zfs_dataset_properties | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: zfs_dataset_properties is defined
  tags: [zfs-properties]

# --- ZFS ACLs ---

- name: Apply ZFS POSIX ACLs
  ansible.posix.acl:
    path: "{{ item.0.path }}"
    entity: "{{ item.1.entity }}"
    etype: "{{ item.1.etype }}"
    permissions: "{{ item.1.permissions }}"
    default: "{{ item.1.default | default(false) }}"
    recursive: true
    state: "{{ item.1.state | default('present') }}"
  loop: "{{ zfs_acls | subelements('entries') + zfs_acls | subelements('default_entries') }}"
  loop_control:
    label: "{{ item.0.path }} {{ item.1.etype }}:{{ item.1.entity }}"
  when: zfs_acls is defined
  tags: [zfs-acl]
