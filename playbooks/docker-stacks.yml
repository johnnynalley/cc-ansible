# =============================================================================
# Docker Stacks Playbook - Deploy Docker Compose Services
# =============================================================================
# Deploys Docker Compose stacks defined in host_vars docker_stacks variable.
# Shows per-service image changes with version labels when available.
# Usage: ansible-playbook playbooks/docker-stacks.yml
#        ansible-playbook playbooks/docker-stacks.yml --limit docker-vm
# =============================================================================

- name: Deploy Docker Compose stacks
  hosts: docker_hosts
  become: true
  gather_facts: true

  tasks:
    # Create Docker networks before starting stacks
    - name: Ensure Docker networks exist
      ansible.builtin.import_tasks: ../tasks/docker-network.yml

    # Create systemd service to start stacks with proper network dependencies
    - name: Create docker-stacks systemd service
      ansible.builtin.template:
        src: ../templates/docker-stacks.service.j2
        dest: /etc/systemd/system/docker-stacks.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload systemd

    - name: Enable docker-stacks service
      ansible.builtin.systemd:
        name: docker-stacks
        enabled: true
        daemon_reload: true

    # -------------------------------------------------------------------------
    # Stacks with build: true - rebuild images from Dockerfile
    # -------------------------------------------------------------------------
    - name: Build and pull images (build stacks)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose build --pull 2>&1
      loop: "{{ docker_stacks | selectattr('build', 'equalto', true) | list }}"
      loop_control:
        label: "{{ item.name }}"
      retries: 3
      delay: 10
      register: build_result
      until: build_result.rc == 0
      changed_when: false

    - name: Detect per-service image changes (build stacks)
      ansible.builtin.script: "{{ playbook_dir }}/../scripts/docker-stack-diff {{ item.item.path }}"
      args:
        executable: /bin/bash
      loop: "{{ build_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      register: build_diff_result
      changed_when: "'(no image changes detected)' not in build_diff_result.stdout"
      when: build_result.results is defined

    - name: Show pending image updates (build stacks)
      ansible.builtin.debug:
        msg: "{{ item.stdout_lines | reject('equalto', '') | list }}"
      loop: "{{ build_diff_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.item.name }}"
      when:
        - item is not skipped
        - item.changed | default(false)

    - name: Determine build stacks needing update
      ansible.builtin.set_fact:
        build_stacks_to_update: >-
          {{ build_diff_result.results | default([])
             | selectattr('changed', 'defined')
             | selectattr('changed', 'equalto', true)
             | map(attribute='item.item')
             | list }}

    - name: Update containers if images changed (build stacks)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose up -d 2>&1
      loop: "{{ build_stacks_to_update | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
      register: up_build_result
      changed_when: "'Recreat' in up_build_result.stdout or 'Creat' in up_build_result.stdout or 'Start' in up_build_result.stdout"

    - name: Show recreated containers (build stacks)
      ansible.builtin.debug:
        msg: "{{ item.stdout_lines }}"
      loop: "{{ up_build_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      when:
        - item is not skipped
        - item.changed | default(false)

    # -------------------------------------------------------------------------
    # Stacks with build: false - pull prebuilt images only
    # -------------------------------------------------------------------------
    - name: Pull images (pull-only stacks)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose pull 2>&1
      loop: "{{ docker_stacks | selectattr('build', 'equalto', false) | list }}"
      loop_control:
        label: "{{ item.name }}"
      retries: 3
      delay: 10
      register: pull_result
      until: pull_result.rc == 0
      changed_when: "'Pull complete' in pull_result.stdout or 'Downloaded newer' in pull_result.stdout"

    - name: Detect per-service image changes (pull-only stacks)
      ansible.builtin.script: "{{ playbook_dir }}/../scripts/docker-stack-diff {{ item.item.path }}"
      args:
        executable: /bin/bash
      loop: "{{ pull_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      register: pull_diff_result
      changed_when: false
      when:
        - pull_result.results is defined
        - item.changed

    - name: Show pending image updates (pull-only stacks)
      ansible.builtin.debug:
        msg: "{{ item.stdout_lines | reject('equalto', '') | list }}"
      loop: "{{ pull_diff_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.item.name }}"
      when:
        - item is not skipped
        - item.stdout_lines | default([]) | reject('equalto', '') | list | length > 0
        - item.stdout_lines | reject('equalto', '') | list != ['(no image changes detected)']

    - name: Update containers if images changed (pull-only stacks)
      ansible.builtin.shell: |
        cd "{{ item.item.path }}" && docker compose up -d 2>&1
      loop: "{{ pull_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      register: up_pull_result
      changed_when: "'Recreat' in up_pull_result.stdout or 'Creat' in up_pull_result.stdout or 'Start' in up_pull_result.stdout"
      when:
        - pull_result.results is defined
        - item.changed or item.stdout is search('Pull complete') or item.stdout is search('Downloaded newer')

    - name: Show recreated containers (pull-only stacks)
      ansible.builtin.debug:
        msg: "{{ item.stdout_lines }}"
      loop: "{{ up_pull_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.item.name }}"
      when:
        - item is not skipped
        - item.changed | default(false)

    # -------------------------------------------------------------------------
    # Ensure stacks are in desired state (start: true/false, default true)
    # -------------------------------------------------------------------------
    - name: Start stacks (start=true or undefined)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose up -d 2>&1
      loop: "{{ docker_stacks | selectattr('start', 'undefined') | list + docker_stacks | selectattr('start', 'defined') | selectattr('start', 'equalto', true) | list }}"
      loop_control:
        label: "{{ item.name }}"
      register: start_result
      changed_when: "'Started' in start_result.stdout or 'Created' in start_result.stdout"

    - name: Stop stacks (start=false)
      ansible.builtin.shell: |
        cd "{{ item.path }}" && docker compose stop 2>&1
      loop: "{{ docker_stacks | selectattr('start', 'defined') | selectattr('start', 'equalto', false) | list }}"
      loop_control:
        label: "{{ item.name }}"
      register: stop_result
      changed_when: "'Stopped' in stop_result.stdout"

    - name: Prune dangling Docker images
      community.docker.docker_prune:
        images: true
      register: prune_result

    - name: Report pruned images
      ansible.builtin.debug:
        msg: "Reclaimed {{ prune_result.images_space_reclaimed | default(0) | human_readable }} from {{ prune_result.images | default([]) | length }} image(s)"
      when: prune_result.images | default([]) | length > 0

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
