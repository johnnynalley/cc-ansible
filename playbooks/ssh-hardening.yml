# =============================================================================
# SSH Hardening Playbook
# =============================================================================
# Ensures SSH is configured securely across all Linux hosts
# Usage: ansible-playbook playbooks/ssh-hardening.yml
# =============================================================================

- name: Configure SSH hardening
  hosts: linux_hosts
  become: true
  gather_facts: true

  tasks:
    - name: Enable SSH public key authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PubkeyAuthentication'
        line: 'PubkeyAuthentication yes'
        validate: "sshd -t -f %s"
      notify: Reload SSH
      tags: [ssh, harden]

    - name: Disable SSH password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication {{ "yes" if ssh_password_auth | default(false) else "no" }}'
        validate: "sshd -t -f %s"
      notify: Reload SSH
      tags: [ssh, harden]

    - name: Set PermitRootLogin
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin {{ ssh_permit_root_login | default("prohibit-password") }}'
        validate: "sshd -t -f %s"
      notify: Reload SSH
      tags: [ssh, harden]

    # Tailscale SSH invokes login(1) with PAM service 'remote'.
    # Without this file, PAM falls back to 'other' which lacks
    # pam_motd.so, so no MOTD is displayed on Tailscale SSH login.
    - name: Create PAM config for Tailscale SSH (remote service)
      ansible.builtin.copy:
        content: |
          # /etc/pam.d/remote - Tailscale SSH sessions
          # Tailscale invokes login(1) with PAM service 'remote'.
          # Without this file, PAM falls back to 'other' (no MOTD).

          @include common-auth
          @include common-account

          session    required     pam_loginuid.so
          session    optional     pam_motd.so  motd=/run/motd.dynamic
          session    optional     pam_motd.so noupdate

          @include common-session
          @include common-password
        dest: /etc/pam.d/remote
        owner: root
        group: root
        mode: "0644"
      tags: [ssh, motd]

    # =========================================================================
    # Custom MOTD scripts for Debian (non-Ubuntu) hosts
    # =========================================================================
    # Ubuntu has landscape-common + update-notifier-common for rich MOTD.
    # Debian only ships 10-uname. These scripts provide similar system info.

    - name: Deploy custom MOTD scripts (Debian non-Ubuntu)
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "/etc/update-motd.d/{{ item.dest }}"
        owner: root
        group: root
        mode: "0755"
      loop:
        - { src: ../templates/motd-header.sh.j2, dest: "00-header" }
        - { src: ../templates/motd-sysinfo.sh.j2, dest: "50-sysinfo" }
        - { src: ../templates/motd-updates.sh.j2, dest: "90-updates" }
        - { src: ../templates/motd-reboot-required.sh.j2, dest: "98-reboot-required" }
      when:
        - ansible_facts.os_family == "Debian"
        - ansible_facts.distribution != "Ubuntu"
      tags: [ssh, motd]

    - name: Remove stock 10-uname (replaced by 00-header)
      ansible.builtin.file:
        path: /etc/update-motd.d/10-uname
        state: absent
      when:
        - ansible_facts.os_family == "Debian"
        - ansible_facts.distribution != "Ubuntu"
      tags: [ssh, motd]

    - name: Remove static /etc/motd boilerplate (Debian non-Ubuntu)
      ansible.builtin.copy:
        content: ""
        dest: /etc/motd
        owner: root
        group: root
        mode: "0644"
      when:
        - ansible_facts.os_family == "Debian"
        - ansible_facts.distribution != "Ubuntu"
      tags: [ssh, motd]

  handlers:
    - name: Reload SSH
      ansible.builtin.systemd:
        name: "{{ 'ssh' if ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian' else 'sshd' }}"
        state: reloaded
