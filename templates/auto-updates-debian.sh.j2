#!/bin/bash
# Auto-updates script for Debian/Ubuntu
# Managed by Ansible - do not edit manually

set -euo pipefail

LOG_TAG="auto-updates"

log() { logger -t "$LOG_TAG" "$*"; echo "$*"; }

send_notification() {
    local title="$1"
    local body="${2:-}"
    local type="${3:-info}"
    curl -sf -o /dev/null \
      -X POST "{{ apprise_endpoint }}/notify/{{ apprise_token }}" \
      --form-string "title=${title}" \
      --form-string "body=${body}" \
      --form-string "tag={{ apprise_alert_tags }}" \
      --form-string "type=${type}" \
      --max-time 10 \
      --retry 2 \
      --retry-delay 3 2>/dev/null || true
}

log "Starting automatic updates..."

# Update package lists
log "Updating apt cache..."
apt-get update -qq

# Count upgradable packages
UPDATE_COUNT=$(apt list --upgradable 2>/dev/null | grep -c upgradable || echo 0)

if [[ "$UPDATE_COUNT" -gt 0 ]]; then
    log "$UPDATE_COUNT packages to upgrade"
    send_notification "[Updates] ${HOSTNAME}" "${UPDATE_COUNT} packages to upgrade"

    # Upgrade all packages
    log "Upgrading packages..."
    DEBIAN_FRONTEND=noninteractive apt-get full-upgrade -y \
      -o Dpkg::Options::="--force-confdef" \
      -o Dpkg::Options::="--force-confold"

    # Clean up
    log "Cleaning up..."
    apt-get autoremove -y
    apt-get autoclean -y

else
    log "All packages are up to date"
fi

# Check if reboot required
REBOOT_NEEDED=false

# Standard Debian/Ubuntu check (dpkg trigger from linux-image-* packages)
if [ -f /var/run/reboot-required ]; then
    REBOOT_NEEDED=true
    log "Reboot required (reboot-required flag set)"
fi

# Proxmox kernel check â€” proxmox-kernel-* packages don't set reboot-required
if [ "$REBOOT_NEEDED" = "false" ]; then
    RUNNING_KERNEL=$(uname -r)
    LATEST_KERNEL=$(ls -t /boot/vmlinuz-* 2>/dev/null | head -1 | sed 's|/boot/vmlinuz-||')
    if [ -n "$LATEST_KERNEL" ] && [ "$RUNNING_KERNEL" != "$LATEST_KERNEL" ]; then
        REBOOT_NEEDED=true
        log "Reboot required (running ${RUNNING_KERNEL}, installed ${LATEST_KERNEL})"
    fi
fi

if [ "$REBOOT_NEEDED" = "true" ]; then
    if [ "{{ auto_updates_reboot_if_required | default(true) | lower }}" = "true" ]; then
        send_notification "[Updates] ${HOSTNAME}: rebooting" "Reboot required after updates, rebooting in 1 minute" "warning"
        shutdown -r +1 "Auto-updates: rebooting in 1 minute"
    else
        log "Reboot required but auto-reboot disabled"
        send_notification "[Updates] ${HOSTNAME}" "Reboot required but auto-reboot is disabled" "warning"
    fi
else
    log "No reboot required"
    if [[ "$UPDATE_COUNT" -gt 0 ]]; then
        send_notification "[Updates] ${HOSTNAME}" "Updates complete, no reboot required"
    fi
fi

log "Auto-updates complete"
