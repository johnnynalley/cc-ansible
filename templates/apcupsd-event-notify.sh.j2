#!/bin/bash
# apcupsd event notification script - Managed by Ansible
# Sends notifications for UPS events via Apprise

EVENT="$1"
HOSTNAME=$(hostname)

APPRISE_ENDPOINT="{{ apprise_endpoint }}"
APPRISE_TOKEN="{{ apprise_token }}"
APPRISE_TAGS="{{ apprise_alert_tags }}"

send_notify() {
    local subject="$1"
    local body="$2"

    curl -sf -o /dev/null \
      -X POST "${APPRISE_ENDPOINT}/notify/${APPRISE_TOKEN}" \
      --form-string "title=[UPS] ${HOSTNAME}: ${subject}" \
      --form-string "body=${body}" \
      --form-string "tag=${APPRISE_TAGS}" \
      --form-string "type=warning" \
      --max-time 30 \
      --retry 3 \
      --retry-delay 5
}

case "$EVENT" in
    onbattery)
        STATUS=$(apcaccess status 2>/dev/null || echo "Unable to query status")
        send_notify "Running on battery power" "UPS is now running on battery power.

UPS Status:
${STATUS}"
        ;;
    offbattery)
        STATUS=$(apcaccess status 2>/dev/null || echo "Unable to query status")
        send_notify "Power restored" "UPS is back on mains power.

UPS Status:
${STATUS}"
        ;;
    commfailure)
        send_notify "Communication failure" "Lost communication with UPS."
        ;;
    commok)
        send_notify "Communication restored" "Communication with UPS restored."
        ;;
esac

exit 0
